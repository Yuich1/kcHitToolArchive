let hasBbList=!1,hasCvList=!1,hasCaList=!1,hasClList=!1,hasDdList=!1,hasMyFleetTypeList=[hasBbList,hasCvList,hasCaList,hasClList,hasDdList],hasEnemyBbList=!1,hasEnemyCvList=!1,hasEnemyCaList=!1,hasEnemyClList=!1,hasEnemyDdList=!1,hasEnemyAvList=!1,hasEnemyEventList=!1,hasEnemyFleetTypeList=[hasEnemyBbList,hasEnemyCvList,hasEnemyCaList,hasEnemyClList,hasEnemyDdList,,,hasEnemyAvList,hasEnemyEventList],selectedMyFleetList=[],selectedFleetNum=1,selectedEnemyFleet,selectedItem=[],itemAccuracy=0,isKira=!1,isItemOpen=!1;const MyFleet=function(fleet,item){this.fleet=fleet,this.item=item,this.impr=[]};$((function(){$("#select-myfleet").on("shown.bs.modal",(function(){var ua=navigator.userAgent;ua.indexOf("iPhone")>0||ua.indexOf("Android")>0&&ua.indexOf("Mobile")>0||ua.indexOf("iPad")>0||ua.indexOf("Android")>0||$(".search-fleet").focus()})),$("#select-myitem").on("shown.bs.modal",(function(){var ua=navigator.userAgent;ua.indexOf("iPhone")>0||ua.indexOf("Android")>0&&ua.indexOf("Mobile")>0||ua.indexOf("iPad")>0||ua.indexOf("Android")>0||$(".search-item").focus()})),$(".focus-fleet").on("click",(function(){var ua=navigator.userAgent;ua.indexOf("iPhone")>0||ua.indexOf("Android")>0&&ua.indexOf("Mobile")>0||ua.indexOf("iPad")>0||ua.indexOf("Android")>0||$(".search-fleet").focus()})),$(".focus-item").on("click",(function(){var ua=navigator.userAgent;ua.indexOf("iPhone")>0||ua.indexOf("Android")>0&&ua.indexOf("Mobile")>0||ua.indexOf("iPad")>0||ua.indexOf("Android")>0||$(".search-item").focus()})),$("#create-myfleet, #myfleet-img, #myfleet-name").on("click",(function(){$(".search-fleet").val(""),$("#select-myfleet .fleet-name").parent().css("display","block"),setFleetList(1,!1)})),$("#cv-tab").on("click",(function(){setFleetList(2,!1)})),$("#ca-tab").on("click",(function(){setFleetList(3,!1)})),$("#cl-tab").on("click",(function(){setFleetList(4,!1)})),$("#dd-tab").on("click",(function(){setFleetList(5,!1)})),$("#av-tab").on("click",(function(){setFleetList(8,!1)})),$("#create-enemy, #enemy-img, #enemy-name").on("click",(function(){setFleetList(1,!0)})),$("#cv-tab-enemy").on("click",(function(){setFleetList(2,!0)})),$("#ca-tab-enemy").on("click",(function(){setFleetList(3,!0)})),$("#cl-tab-enemy").on("click",(function(){setFleetList(4,!0)})),$("#dd-tab-enemy").on("click",(function(){setFleetList(5,!0)})),$("#av-tab-enemy").on("click",(function(){setFleetList(8,!0)})),$("#event-tab-enemy").on("click",(function(){setFleetList(9,!0)})),$(".save-fleet-button").on("click",(function(){$(".fleet-banners").empty();for(let i=0;len=selectedMyFleetList.length-1,i<len;i++){const ship=selectedMyFleetList[i+1].fleet,img=$("<img>",{class:"banner",src:`./images/ships/${ship.id}.png`,alt:`${ship.name}`});$(".fleet-banners").append(img),(i+1)%3==0&&0!=i&&$(".fleet-banners").append($("<br>"))}const fleetNumber=getSavedFleetNumber();$(".fleet-name").val("編成"+(fleetNumber+1))})),$("#save-fleet-button").on("click",(function(){const fleetName=getFleetName(),fleetComment=getFleetComment(),deckCode=getDeckBuilder(),fleetNumber=getSavedFleetNumber(),isSuccess=saveFleet(fleetName,fleetComment,deckCode,fleetNumber);isSuccess?setSavedFleetList():alert("空の艦隊で上書きできません")})),$(".save-fleet").on("click",(function(){setSavedFleetList()})),$("#kira").on("click",(function(){const button=$("#kira");isKira=!isKira,isKira?(button.attr("class","btn btn-default btn-sm kira"),button.html("キラを消す")):(button.attr("class","btn btn-default btn-sm no-kira"),button.html("キラを付ける")),getResultData(),this.blur()})),$(".myfleet .lv").on("input",(function(){const f=$(".myfleet .lv");f.val(Math.max(f.val(),1)),f.val(Math.min(f.val(),175)),getResultData()})),$(".myfleet .luck").on("input",(function(){const f=$(".myfleet .luck");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .armor").on("input",(function(){const f=$(".enemy .armor");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .hp").on("input",(function(){const f=$(".enemy .hp");f.val(Math.max(f.val(),1)),getResultData()})),$(".enemy .luck").on("input",(function(){const f=$(".enemy .luck");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .avoidance").on("input",(function(){const f=$(".enemy .avoidance");f.val(Math.max(f.val(),0)),getResultData()})),$(".enemy .hp, .enemy .armor, .enemy .luck, .enemy .avoidance").on("input",(function(){let hp=$(".enemy .hp").val(),armor=$(".enemy .armor").val();saveEnemyStatus(selectedEnemyFleet.id,hp,armor,$(".enemy .avoidance").val(),$(".enemy .luck").val());const title=`装甲 ${armor}, 耐久 ${hp}`;$(`[data-id="${selectedEnemyFleet.id}"]`).children(".item-tooltip").attr("title",title).tooltip("fixTitle")})),$(".saved-info .status-reset").on("click",(function(){resetEnemyStatus(selectedEnemyFleet.id),$(".status-reset").css("display","none"),$(".status").removeClass("saved-info"),getResultData()})),$(".my-formation, .enemy-formation, .critical").on("input",(function(){getResultData()})),$(".engagement").on("input",(function(){setSauin(1!=$(".engagement").val().split(",").length),getResultData()})),$(".search-fleet").on("input",(function(){search("#select-myfleet .fleet-name",$(this).val())})),$(".search-item").on("input",(function(){$(".search-item").focus(),search(".item-list .item",$(this).val())})),$("#delete-fleet").on("click",(function(){const fleetNumber=parseInt($("#delete-fleet").attr("data-fleetnumber"));deleteFleet(fleetNumber),setSavedFleetList()})),changeFleet(1592),initItemList(),$(".fleet-select").on("click",(function(){let selectedMyFleet;if($(".fleet-select.active").removeClass("active"),$(this).addClass("active"),selectedFleetNum=$(this).text(),selectedMyFleetList[selectedFleetNum]&&(selectedMyFleet=selectedMyFleetList[selectedFleetNum].fleet,selectedItem=selectedMyFleetList[selectedFleetNum].item),selectedMyFleet){const selectedFleet=selectedMyFleet,state=selectedFleet.state,luck=selectedFleet.luck,id=selectedFleet.id,src=`./images/ships/${id}.png`;let setState=state;"未改造"!=setState&&"normal"!=setState||(setState="");const setName=selectedFleet.name+" "+setState,power=2==selectedMyFleet.type?Math.floor(1.5*(selectedMyFleet.power-1))+55:selectedMyFleet.power+4;$(".myfleet .fleet-name").html(setName),$(".myfleet .fleet-img").attr("src",src),$(".myfleet .luck").val(luck),$(".myfleet .power").html(power),$(".myfleet .lv").val(selectedMyFleet.lv),setItemTab(selectedMyFleetList[selectedFleetNum].fleet.type),setItemForm(),updateItemList()}else{const src="./images/ships/0.png";$(".myfleet .fleet-img").attr("src",src),$(".myfleet .fleet-name").html("未選択"),$(".myfleet .luck").val(""),$(".myfleet .power").html(""),$(".myfleet .lv").val(""),$(".items tbody").html("")}if(selectedMyFleet)for(let i=0;i<selectedMyFleet.slot+1;i++)selectedItem[i]&&0!=selectedItem[i]&&(selectedItem[i].isImpr&&setImpr(i),setItem(i,selectedItem[i]));else $(".items tbody").html();getResultData()})),$(".share").on("click",(function(){const deck=getDeckBuilder();$(".deck").val(deck)})),$(".deckBuilder").on("click",(function(){$(".deck").select(),document.execCommand("copy"),window.getSelection().removeAllRanges()})),$(".deck").on("click",(function(){$(this).select()})),$(".deck").on("input",(function(){const isOpen=checkDeckBuilder($(this).val());isOpen&&$("#share").modal("hide")})),$(".deckBuilderOpen").on("click",(function(){const t="http://kancolle-calc.net/deckbuilder.html?predeck="+getDeckBuilder();window.open(t,"newtab")}))}));const setFleetList=(shipType,isEnemy)=>{if(hasMyFleetTypeList[shipType-1]&&!isEnemy)return;if(hasEnemyFleetTypeList[shipType-1]&&isEnemy)return;let shipList,targetId;isEnemy?(shipList=ENEMY_DATA,targetId=`#${SHIP_TYPE.find(item=>item.id===shipType).type}-enemy`,hasEnemyFleetTypeList[shipType-1]=!0):(shipList=SHIP_DATA,targetId=`#${SHIP_TYPE.find(item=>item.id===shipType).type}`,hasMyFleetTypeList[shipType-1]=!0);for(let index=0;len=shipList.length,index<len;index++){const ship=shipList[index];if(ship.type==shipType){const main_id=ship.main_id,name=ship.name,tr=$("<tr>"),td=$("<td>"),img=$("<img>",{class:"banner",src:`./images/ships/${main_id}.png`,alt:`${name}`,"data-dismiss":"modal","data-id":`${main_id}`,"data-main_id":`${main_id}`}),span=$("<span>",{class:"fleet-name",text:`${name}`}),yomi=$("<span>",{class:"my-hidden fleet-yomi",text:`${ship.yomi}`});let selectedFleet;td.append(img).append(span.append(yomi)),tr.append(td);for(let index=0;len=ship.remodel.length,index<len;index++){selectedFleet=Object.assign({},ship.remodel[index]);const state=selectedFleet.state;let title;if(selectedFleet.id<1501)title=`${selectedFleet.power?`火力 ${selectedFleet.power}, `:""}${selectedFleet.luck?`運 ${selectedFleet.luck}`:""}`;else{let hp=0,armor=0;const storageData=localStorage.getItem(selectedFleet.id),savedStatus=storageData?storageData.split(","):0;hp=savedStatus[2]?parseInt(savedStatus[2]):selectedFleet.hp,armor=savedStatus[3]?parseInt(savedStatus[3]):selectedFleet.armor,title=`${selectedFleet.armor?`装甲 ${armor}, `:""}${selectedFleet.hp?`耐久 ${hp}`:""}`}const button=$("<button>",{type:"button",class:"btn btn-default set-fleet","data-dismiss":"modal","data-id":`${selectedFleet.id}`,"data-main_id":`${main_id}`}).append($("<div>",{class:"item-tooltip","data-toggle":"tooltip",title:title,text:state}));td.append(button)}$(`${targetId} .table tbody`).append(tr)}}$('[data-toggle="tooltip"]').tooltip(),$(`${targetId} .set-fleet, ${targetId} .banner`).on("click",(function(){changeFleet($(this).data("id")),isEnemy||(setItemTab(selectedMyFleetList[selectedFleetNum].fleet.type),resetItemAccuracy(),setItemForm(),updateItemList()),getResultData(),console.log("test")}))},setItemForm=()=>{$(".myfleet .items tr").remove();const slot=selectedMyFleetList[selectedFleetNum].fleet.slot;for(let index=0;index<slot;index++){const button=$("<button>",{type:"button",class:"btn btn-default item",id:`itemSlot${index}`,"data-toggle":"modal","data-target":"#select-myitem",text:"装備"+(index+1),value:index});button.on("click",(function(){$(".search-item").val("")}));const remove=$("<button>",{type:"button",class:"btn btn-default item-opt",html:"&times;"});remove.on("click",(function(){selectedMyFleetList[selectedFleetNum].item[index].isImpr&&$(`#impr${index}`).parent().remove(),setItem(index,0)}));const tr=$("<tr>").append($("<td>").append(button)).append($("<td>").append(remove));$(".myfleet .items tbody").append(tr),selectedMyFleetList[selectedFleetNum].item[index]||setItem(index,0)}const button=$("<button>",{type:"button",class:"btn btn-default item add-item",id:`itemSlot${slot}`,"data-toggle":"modal","data-target":"#select-myitem",text:"補強増設"});button.on("click",(function(){$(".search-item").val(""),$(".search-item").focus()}));const remove=$("<button>",{type:"button",class:"btn btn-default item-opt",html:"&times;"});remove.on("click",(function(){setItem(slot,0)}));const tr=$("<tr>").append($("<td>").append(button)).append($("<td>").append(remove));$(".myfleet .items tbody").append(tr),selectedMyFleetList[selectedFleetNum].item[slot]||setItem(slot,0)},initItemList=()=>{const itemType=[{type:"l-gun",id:[3]},{type:"m-gun",id:[2]},{type:"s-gun",id:[1]},{type:"secondaly-gun",id:[4]},{type:"fighter",id:[7]},{type:"attacker",id:[8]},{type:"bomber",id:[9,10]},{type:"torpedo",id:[5,6]},{type:"radar",id:[14,15,30]},{type:"scout",id:[27]},{type:"heli",id:[31]},{type:"other",id:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,32]}],expansionItemType=[18,25,26,28];let targetTabId;$(".item-list .table tr").remove(),isItemOpen=!0;for(let index=0;len=ITEM_DATA.length,index<len;index++){const item=$.extend(!0,{},ITEM_DATA[index]);for(let index=0;len=itemType.length,index<len;index++)if(-1!=itemType[index].id.indexOf(item.type)){targetTabId=itemType[index].type;break}let title=`${item.power?`火力 ${item.power}, `:""}${item.bomb?`爆装 ${item.bomb}, `:""}${item.torp?`雷装 ${item.torp}, `:""}${item.accuracy?`命中 ${item.accuracy}`:""}`,tip=$("<div>",{class:"item-tooltip","data-toggle":"tooltip",title:title,text:item.name});const button=$("<button>",{type:"button",class:`btn btn-default item type${item.type} id${item.id}`,"data-toggle":"modal","data-target":"#select-myitem"}).append(tip),yomi=$("<span>",{class:"my-hidden item-yomi",text:`${item.yomi}`});button.append(yomi);const arrow=$("<span>",{class:"arrow"});arrow.hide(),button.append(arrow),button.parent().hide();const tr=$("<tr>").append($("<td>").append(button));$(`#${targetTabId} tbody`).append(tr),$('[data-toggle="tooltip"]').tooltip()}},updateItemList=()=>{const itemType=[{type:"l-gun",id:[3]},{type:"m-gun",id:[2]},{type:"s-gun",id:[1]},{type:"secondaly-gun",id:[4]},{type:"fighter",id:[7]},{type:"attacker",id:[8]},{type:"bomber",id:[9,10]},{type:"torpedo",id:[5,6]},{type:"radar",id:[14,15,30]},{type:"scout",id:[27]},{type:"heli",id:[31]},{type:"other",id:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,32]}],expansionItemType=[18,25,26,28];$(".myfleet .item").on("click",(function(){let targetTabId;const slotButtonId=this.id,slotNumber=parseInt(slotButtonId.charAt(slotButtonId.length-1)),fleet=selectedMyFleetList[selectedFleetNum].fleet;let isExpansionSlot=fleet.slot==slotButtonId.charAt(slotButtonId.length-1);isItemOpen=!0;for(let index=0;len=ITEM_DATA.length,index<len;index++){const item=$.extend(!0,{},ITEM_DATA[index]);let isException=!1,isSpecial=!1,isExpansion=!1,canHave=!1;const button=$(`.id${item.id}`);if(isExpansionSlot?(isExpansion=expansionItemType.some(c=>c==item.type),canHave=SHIP_TYPE[fleet.type-1].canHaveItem.some(c=>c==item.type)&&isExpansion):canHave=SHIP_TYPE[fleet.type-1].canHaveItem.some(c=>c==item.type),canHave){const isExceptionId=!!fleet.cantHaveItemId&&fleet.cantHaveItemId.some(c=>c==item.id),isExceptionType=!!fleet.cantHaveItemType&&fleet.cantHaveItemType.some(c=>c==item.type);isException=isExceptionId||isExceptionType}else{const isSpecialId=!!fleet.specialCanHaveItemId&&fleet.specialCanHaveItemId.some(c=>c==item.id),isSpecialType=!!fleet.specialCanHaveItemType&&fleet.specialCanHaveItemType.some(c=>c==item.type);if(isExpansionSlot){const t=!!fleet.expansionCanHaveItemId&&fleet.expansionCanHaveItemId.some(c=>c==item.id);isSpecial=t||(isSpecialId||isSpecialType)&&isExpansion}else isSpecial=isSpecialId||isSpecialType}if(canHave&&!isException||isSpecial){for(let index=0;len=itemType.length,index<len;index++)if(-1!=itemType[index].id.indexOf(item.type)){targetTabId=itemType[index].type;break}button.parent().show();const r=!!item.singleAddableBonus&&getSingleAddableBonus(item).power>0;if(r)button.children(".arrow").show();else{const s=!!item.singleBonus&&getSingleBonus(item,slotNumber).power>0;if(s)button.children(".arrow").show();else{const t=getMultiBonus(selectedMyFleetList[selectedFleetNum].item).power,itemBefore=selectedMyFleetList[selectedFleetNum].item[slotNumber];selectedMyFleetList[selectedFleetNum].item[slotNumber]=item;const ta=getMultiBonus(selectedMyFleetList[selectedFleetNum].item).power;selectedMyFleetList[selectedFleetNum].item[slotNumber]=itemBefore,ta-t>0?button.children(".arrow").show():button.children(".arrow").hide()}}}else button.parent().hide();button.off("mouseover"),button.on("mouseover",(function(){if(isItemOpen){const t=getMultiBonus(selectedMyFleetList[selectedFleetNum].item),itemBefore=selectedMyFleetList[selectedFleetNum].item[slotNumber],r=item.singleAddableBonus?getSingleAddableBonus(item):0,s=item.singleBonus?getSingleBonus(item,slotNumber):0;selectedMyFleetList[selectedFleetNum].item[slotNumber]=item;const ta=getMultiBonus(selectedMyFleetList[selectedFleetNum].item);selectedMyFleetList[selectedFleetNum].item[slotNumber]=itemBefore;const bonusPower=(r.power?r.power:0)+(s.power?s.power:0)+ta.power-t.power,bonusTorp=(r.torp?r.torp:0)+(s.torp?s.torp:0)+ta.torp-t.torp,title=`${item.power?`火力 ${item.power}`:`${0!=bonusPower?"火力 ":""}`}${0!=bonusPower?`(${bonusPower>0?"+":""}${bonusPower}), `:`${item.power?", ":""}`}${item.bomb?`爆装 ${item.bomb}, `:""}${item.torp?`雷装 ${item.torp}`:""}${0!=bonusTorp?`(+${bonusTorp})`:""}${item.torp||0!=bonusTorp?", ":""}${item.accuracy?`命中 ${item.accuracy}`:""}`;$(this).children(".item-tooltip").attr("title",title).tooltip("fixTitle").tooltip("show"),$('[data-toggle="tooltip"]').tooltip()}})),button.off("click"),button.on("click",(function(){isItemOpen=!1,selectedMyFleetList[selectedFleetNum].item[slotNumber].isImpr&&$(`#impr${slotNumber}`).parent().remove(),item.isImpr&&setImpr(slotNumber),setItem(slotNumber,item)}))}}))},resetItemAccuracy=()=>{itemAccuracy=0,selectedMyFleetList[selectedFleetNum].item.length=0,$(".myfleet .accuracy").html(itemAccuracy)},changeFleet=id=>{let shipData,selectedFleet;shipData=id>1500?ENEMY_DATA:SHIP_DATA;let name="";for(let index=0;len=shipData.length,index<len;index++){const ship=shipData[index];if(-1!=ship.id_list.indexOf(id)){name=ship.name;for(let index=0;len=ship.remodel.length,index<len;index++){if(ship.remodel[index].id==id&&id<=1500){const i=Array(ship.remodel[index].slot).fill(0),myFleet=new MyFleet(ship.remodel[index],i);myFleet.fleet.type=ship.type,myFleet.fleet.name=name,selectedMyFleetList[selectedFleetNum]=myFleet,selectedFleet=myFleet.fleet;break}if(ship.remodel[index].id==id){selectedEnemyFleet=ship.remodel[index],selectedEnemyFleet.type=ship.type,selectedFleet=selectedEnemyFleet;break}}}}if(!selectedFleet)return;const state=selectedFleet.state;let luck=selectedFleet.luck;const src=`./images/ships/${id}.png`;let setState=state;"未改造"!=setState&&"normal"!=setState||(setState="");const setName=name+" "+setState,defaultLevel=99;if(id>1500){$(".enemy .fleet-name").html(setName),$(".enemy .fleet-img").attr("src",src),$(".enemy .hp").val(selectedFleet.hp),$(".enemy .armor").val(selectedFleet.armor);let avoidance=0,hp=selectedFleet.hp,armor=selectedFleet.armor;if(localStorage.getItem(selectedEnemyFleet.id)){const savedStatus=localStorage.getItem(selectedEnemyFleet.id).split(",");savedStatus[0]&&(avoidance=parseInt(savedStatus[0])),savedStatus[1]&&(luck=parseInt(savedStatus[1])),savedStatus[2]&&(hp=parseInt(savedStatus[2])),savedStatus[3]&&(armor=parseInt(savedStatus[3])),$(".status-reset").css("display","block"),$(".status").addClass("saved-info")}else avoidance=selectedFleet.avoidance+selectedFleet.avoidance_item,$(".status-reset").css("display","none"),$(".status").removeClass("saved-info");$(".enemy .hp").val(hp),$(".enemy .armor").val(armor),$(".enemy .avoidance").val(avoidance),$(".enemy .luck").val(luck)}else{const power=2==selectedFleet.type?Math.floor(1.5*(selectedFleet.power-1))+55:selectedFleet.power+4;$(".myfleet .fleet-name").html(setName),$(".myfleet .fleet-img").attr("src",src),$(".myfleet .luck").val(luck),$(".myfleet .power").html(power),$(".myfleet .lv").val(99)}getResultData()},setItem=(slotNumber,item)=>{const itemSlot=$(`#itemSlot${slotNumber}`);if(slotNumber!=selectedMyFleetList[selectedFleetNum].fleet.slot||item.name)itemSlot.text(item.name?item.name:`装備${slotNumber+1}`),itemSlot.removeClass((function(index,className){return(className.match(/\btype\S+/g)||[]).join(" ")})),itemSlot.addClass(`type${item.type}`);else{const text="補強増設";itemSlot.text(text),itemSlot.removeClass((function(index,className){return(className.match(/\btype\S+/g)||[]).join(" ")})),itemSlot.addClass(`type${item.type}`)}selectedMyFleetList[selectedFleetNum].item[slotNumber]=item;let itemPower=0,itemTorp=0,itemBomb=0,power=0;power+=selectedMyFleetList[selectedFleetNum].fleet.power,itemAccuracy=0;const singleAddableBonus=item.singleAddableBonus?getSingleAddableBonus(item):0,singleBonus=item.singleBonus?getSingleBonus(item,slotNumber):0,multiBonus=getMultiBonus(selectedMyFleetList[selectedFleetNum].item);selectedMyFleetList[selectedFleetNum].item[slotNumber].power=selectedMyFleetList[selectedFleetNum].item[slotNumber].power?selectedMyFleetList[selectedFleetNum].item[slotNumber].power:0,selectedMyFleetList[selectedFleetNum].item[slotNumber].torp=(selectedMyFleetList[selectedFleetNum].item[slotNumber].torp?selectedMyFleetList[selectedFleetNum].item[slotNumber].torp:0)+(singleAddableBonus.torp?singleAddableBonus.torp:0)+(singleBonus.torp?singleBonus.torp:0),selectedMyFleetList[selectedFleetNum].item[slotNumber].bonusPower=(singleAddableBonus.power?singleAddableBonus.power:0)+(singleBonus.power?singleBonus.power:0),power+=multiBonus.power?multiBonus.power:0,selectedMyFleetList[selectedFleetNum].item.forEach(t=>{0!=t&&(itemPower+=(t.power?t.power:0)+(t.bonusPower?t.bonusPower:0),itemTorp+=t.torp?t.torp:0,itemBomb+=t.bomb?t.bomb:0,itemAccuracy+=t.accuracy?t.accuracy:0)}),power+=itemPower,2==selectedMyFleetList[selectedFleetNum].fleet.type?power=Math.floor(1.5*(power+itemTorp+Math.floor(1.3*itemBomb)-1))+55:power+=4,selectedMyFleetList[selectedFleetNum].item[slotNumber]=item,$(".myfleet .power").html(power),$(".myfleet .accuracy").html(itemAccuracy),getResultData()},getSingleAddableBonus=item=>{let power=0,accuracy=0,torp=0,bomb=0;return item.singleAddableBonus.forEach(t=>{if(t.targetId.some(c=>c==selectedMyFleetList[selectedFleetNum].fleet.id))return power+=t.power?t.power:0,torp+=t.torp?t.torp:0,bomb+=t.bomb?t.bomb:0,accuracy+=t.accuracy?t.accuracy:0,!0}),{power:power,torp:torp,bomb:bomb,accuracy:accuracy}},getSingleBonus=(item,slotNum)=>{let power=0,accuracy=0,torp=0,bomb=0;return item.singleBonus.forEach(t=>{const checkItemData=selectedMyFleetList[selectedFleetNum].item.slice(0,slotNum);return checkItemData.some(c=>c.id==item.id)?{}:t.targetId.some(c=>c==selectedMyFleetList[selectedFleetNum].fleet.id)?(power+=t.power?t.power:0,torp+=t.torp?t.torp:0,bomb+=t.bomb?t.bomb:0,accuracy+=t.accuracy?t.accuracy:0,!0):void 0}),{power:power,torp:torp,bomb:bomb,accuracy:accuracy}},getMultiBonus=itemList=>{let power=0,accuracy=0,torp=0,bomb=0;for(let index=0;index<selectedMyFleetList[selectedFleetNum].fleet.slot+1;index++){const item=itemList[index];item&&item.multiBonus&&item.multiBonus.forEach(t=>{if(t.targetId.some(c=>c==selectedMyFleetList[selectedFleetNum].fleet.id)&&t.isBonus&&t.isBonus(index))return power+=t.power?t.power:0,torp+=t.torp?t.torp:0,bomb+=t.bomb?t.bomb:0,accuracy+=t.accuracy?t.accuracy:0,!0})}return{power:power,torp:torp,bomb:bomb,accuracy:accuracy}},getHitTerm=(formation_coef,support_const,cond_conef,luck,lv,equip_hit)=>Math.floor(cond_conef*formation_coef*Math.floor(support_const+1.5*Math.sqrt(luck)+2*Math.sqrt(lv)+equip_hit)),getAvoidanceTerm=(avoidance,luck)=>{const formation_coef=FORMATION_AVO_COEF[$(".enemy-formation").val()];let avoidanceTerm=formation_coef*(avoidance+Math.sqrt(2*luck));return avoidanceTerm=Math.floor(avoidanceTerm),avoidanceTerm>=65?Math.floor(55+2*Math.sqrt(avoidanceTerm-65)):avoidanceTerm>=40?Math.floor(40+3*Math.sqrt(avoidanceTerm-40)):avoidanceTerm},getFinalAccuracy=(hitTerm,avoidanceTerm)=>{let finalAccuracy=hitTerm-avoidanceTerm+1;return Math.min(finalAccuracy,97)},getAttack=(attack,formationDamageCoef,engagementDamageCoef)=>((attack=attack*formationDamageCoef*engagementDamageCoef)>170&&(attack=170+Math.sqrt(attack-170)),Math.floor(attack)),getResultData=()=>{let existAvoidance=!0,existLuck=!0;0==$(".enemy .avoidance").val()?($(".enemy .avoidance").addClass("unknown"),existAvoidance=!1):($(".enemy .avoidance").removeClass("unknown"),existAvoidance=!0),0==$(".enemy .luck").val()?($(".enemy .luck").addClass("unknown"),existLuck=!1):($(".enemy .luck").removeClass("unknown"),existLuck=!0);let text="";if(existAvoidance||(text+="回避"),existAvoidance||existLuck||(text+="と"),existLuck||(text+="運"),0!=text.length&&(text+="が未設定です"),$("#unknown-status").text(text),!selectedMyFleetList[selectedFleetNum])return;let sink=0,taiha=0,tyuha=0,shoha=0,fine=0;const hp=$(".enemy .hp").val(),formationDamageCoef=FORMATION_DAMAGE_COEF[parseInt($(".my-formation").val())],engagementDamageCoefs=$(".engagement").val().split(","),criticalFlag=parseFloat($(".critical").val()),support_const=64;let cond_coef=1,formation_coef=FORMATION_ACC_COEF[parseInt($(".my-formation").val())],luck=0,lv=1;lv=$(".myfleet .lv").val(),selectedMyFleetList[selectedFleetNum].fleet.lv=lv,luck=$(".myfleet .luck").val(),selectedMyFleetList[selectedFleetNum].fleet.luck=luck,isKira&&(cond_coef=1.2);let hitTerm=getHitTerm(formation_coef,64,cond_coef,luck,lv,itemAccuracy),avoidanceTerm=getAvoidanceTerm(parseInt($(".enemy .avoidance").val()),parseInt($(".enemy .luck").val())),finalAccuracy=getFinalAccuracy(hitTerm,avoidanceTerm),power=parseInt($(".myfleet .power").text());const armor=parseInt($(".enemy .armor").val()),criticalCoef=[1,1.5];let cappedAttack=0,criticalTerm=0,fineProb=0,shohaProb=0,tyuhaProb=0,taihaProb=0,sinkProb=0;const engagementRates={noSaiun:[.15,.45,.3,.1],saiun:[.15,.45,.4,0]};for(let j=0;len=engagementDamageCoefs.length,j<len;j++){const engagementDamageCoef=parseFloat(engagementDamageCoefs[j]);cappedAttack=Math.floor(getAttack(power,formationDamageCoef,engagementDamageCoef));const trialNumber=100;criticalTerm=2==criticalFlag?100:0,3==criticalFlag&&(criticalTerm=Math.floor(Math.sqrt(finalAccuracy))+1);const criticalTerms=[100-criticalTerm,criticalTerm];for(let i=0;i<2;i++){sink=0,taiha=0,tyuha=0,shoha=0,fine=0;for(let index=0;index<=trialNumber;index++){const randArmor=index/trialNumber*(armor-1),finalAttack=Math.floor(cappedAttack*criticalCoef[i]),damage=Math.floor(finalAttack-(.7*armor+.6*randArmor));damage>=hp?sink++:damage>=.75*hp?taiha++:damage>=.5*hp?tyuha++:damage>=.25*hp?shoha++:fine++}let engagementRate=1;if(engagementDamageCoefs.length>1&&document.getElementById("saiunCheck")){const isSauin=document.getElementById("saiunCheck").checked;engagementRate=isSauin?engagementRates.saiun[j]:engagementRates.noSaiun[j]}fineProb+=fine*criticalTerms[i]/(trialNumber+1)*engagementRate,shohaProb+=shoha*criticalTerms[i]/(trialNumber+1)*engagementRate,tyuhaProb+=tyuha*criticalTerms[i]/(trialNumber+1)*engagementRate,taihaProb+=taiha*criticalTerms[i]/(trialNumber+1)*engagementRate,sinkProb+=sink*criticalTerms[i]/(trialNumber+1)*engagementRate}}let fuel=[],bullet=[];for(let i in selectedMyFleetList){const ship=selectedMyFleetList[i].fleet;ship.lv>99?(fuel[i]=Math.floor(.85*Math.floor(.5*ship.fuel+.99)),bullet[i]=Math.floor(.85*Math.floor(.8*ship.bullet+.99))):(fuel[i]=Math.floor(.5*ship.fuel+.99),bullet[i]=Math.floor(.8*ship.bullet+.99))}$(".result-left").html(`命中項 ${hitTerm}<br>\n        基本回避項 ${0==avoidanceTerm?avoidanceTerm+"<span style='color: #dc143c'>(不明)</span>":avoidanceTerm}<br>\n        最終命中率 ${finalAccuracy}%<br>\n        ${1==engagementDamageCoefs.length?`最終攻撃力 ${3==criticalFlag?`(CL1) ${Math.floor(1*cappedAttack)}, (CL2) ${Math.floor(1.5*cappedAttack)}`:Math.floor(cappedAttack*criticalCoef[criticalFlag-1])}${cappedAttack>=151?"(キャップ到達)":""}<br>\n        クリティカル率 (CL1) ${100-criticalTerm}%, (CL2) ${criticalTerm}%<br></br>`:`クリティカル率 (CL1) ${100-criticalTerm}%, (CL2) ${criticalTerm}%<br></br>`}\n        <br>\n        <div class="sub-title">命中時撃破率</div>\n        撃沈 ${round(sinkProb,1)}%<br>\n        大破 ${round(taihaProb,1)}%<br>\n        中破 ${round(tyuhaProb,1)}%<br>\n        小破 ${round(shohaProb,1)}%<br>\n        小破未満 ${Math.round(fineProb,1)}%`),$(".result-right").html(`<div class="sub-title">命中込み撃沈率</div>\n  撃沈 ${round(sinkProb*finalAccuracy/100,1)}%<br>\n  大破 ${round(taihaProb*finalAccuracy/100,1)}%<br>\n  中破 ${round(tyuhaProb*finalAccuracy/100,1)}%<br>\n  小破 ${round(shohaProb*finalAccuracy/100,1)}%<br>\n  小破未満 ${round(fineProb*finalAccuracy/100,1)}%<br>\n  miss ${100-finalAccuracy}%<br>\n  <br>\n  <div class="sub-title">資材消費</div>\n  燃料 ${fuel[selectedFleetNum]}, 合計${sum(fuel)}<br>\n  弾薬 ${bullet[selectedFleetNum]},合計${sum(bullet)}`),$(".result .progress-bar-miss").attr("style",`width:${100-finalAccuracy}%`),$(".result .progress-bar-miss").html(`miss ${Math.floor(10*(100-finalAccuracy))/10}%`),$(".result .progress-bar-fine").attr("style",`width:${fineProb*finalAccuracy/100}%`),$(".result .progress-bar-fine").html(`小破未満 ${round(fineProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-shoha").attr("style",`width:${shohaProb*finalAccuracy/100}%`),$(".result .progress-bar-shoha").html(`小破 ${round(shohaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-tyuha").attr("style",`width:${tyuhaProb*finalAccuracy/100}%`),$(".result .progress-bar-tyuha").html(`中破 ${round(tyuhaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-taiha").attr("style",`width:${taihaProb*finalAccuracy/100}%`),$(".result .progress-bar-taiha").html(`大破 ${round(taihaProb*finalAccuracy/100,1)}%`),$(".result .progress-bar-sink").attr("style",`width:${sinkProb*finalAccuracy/100}%`),$(".result .progress-bar-sink").html(`撃沈 ${round(sinkProb*finalAccuracy/100,1)}%`)},search=(targetSelector,searchText)=>{let t=searchText.replace(/[Ａ-Ｚａ-ｚ０-９]/g,(function(s){return String.fromCharCode(s.charCodeAt(0)-65248)}));t=t.toLowerCase(),$(targetSelector).parent().css("display","block"),$(targetSelector).each((function(){-1==$(this).text().indexOf(t)&&$(this).parent().css("display","none")}))},getDeckBuilder=()=>{let deck='{"version":4,"f1":{',fleetNum=1;for(let i=0;len=selectedMyFleetList.length+1,i<len;i++)if(selectedMyFleetList[i]){deck+=`${1!=fleetNum?",":""}`;const myFleet=selectedMyFleetList[i];deck+=`"s${fleetNum}":{"id":"${myFleet.fleet.id}","lv":${myFleet.fleet.lv},"luck":${myFleet.fleet.luck},"items":{`,fleetNum++;let itemNum=1;for(let j=0;len=myFleet.item.length+1,j<len;j++)myFleet.item[j]&&(deck+=`${1!=itemNum++?",":""}`,j==myFleet.fleet.slot?deck+=`"ix":{"id":${myFleet.item[j].id},"rf":${myFleet.impr[j]?myFleet.impr[j]:0}}`:deck+=`"i${j+1}":{"id":${myFleet.item[j].id},"rf":${myFleet.impr[j]?myFleet.impr[j]:0}}`);deck+="}}"}return deck+="}}",deck},checkDeckBuilder=dataString=>{const raw=JSON.parse(dataString);if(toString(raw.version).includes("4"))return!1;let fleets=[];const fleetIndex=["f1","f2","f3","f4"];for(let i=0;i<4;i++){const fleet=raw[fleetIndex[i]];fleet&&Object.keys(fleet).length>0&&fleets.push(fleet)}let selectedData;return 1==fleets.length?(selectedData=fleets.pop(),setDeckBuilder(selectedData)):fleets.length>0&&(setDeckList(fleets),$("#select-deckbuilder").modal("show")),!0};function setDeckBuilder(json){const fleetNum=selectedFleetNum;selectedFleetNum=1;for(const i in json){if(!json[i])continue;const ship=json[i];changeFleet(parseInt(ship.id)),$(".myfleet .lv").val(ship.lv),$(".myfleet .luck").val(ship.luck),selectedMyFleetList[selectedFleetNum].fleet.lv=ship.lv,selectedMyFleetList[selectedFleetNum].fleet.luck=ship.luck,resetItemAccuracy(),setItemForm();const items=ship.items;for(const k in items){const itemId=items[k].id;let item;for(let t=0;len=ITEM_DATA.length,t<len;t++)if(ITEM_DATA[t].id==itemId){item=ITEM_DATA[t];break}item&&(setItem("x"==k[1]?selectedMyFleetList[selectedFleetNum].fleet.slot:k[1]-1,item),0!=items[k].rf&&(selectedMyFleetList[selectedFleetNum].impr[k[1]-1]=items[k].rf,setImpr(k[1]-1)))}selectedFleetNum++}return selectedFleetNum=fleetNum,$(".fleet-select")[0].click(),setItemTab(selectedMyFleetList[selectedFleetNum].fleet.type),!0}const sum=function(arr){return arr.reduce((function(prev,current,i,arr){return prev+current}))},setDeckList=deckCodeList=>{$(".select-fleetlist tbody").empty();for(let i=0;i<deckCodeList.length;i++){const listObj=$("<tr>",{class:"select-fleet"}),banner=$("<td>"),fleet=deckCodeList[i];for(let j=0;j<Object.keys(fleet).length;j++){const ship=fleet[`s${j+1}`],img=$("<img>",{class:"banner",src:`./images/ships/${ship.id}.png`,alt:`${ship.name}`});banner.append(img),(j+1)%2==0&&0!=j&&banner.append($("<br>"))}const button=$("<button>",{type:"button",class:"btn btn-default",text:"展開","data-dismiss":"modal"});button.on("click",(function(){$("#share").modal("hide"),setDeckBuilder(deckCodeList[i])}));const fleetName=`第${i+1}艦隊`,text=$("<td>");text.append(fleetName).append($("<br>")).append($("<br>")).append(button),listObj.append(banner).append(text),$(".select-fleetlist tbody").append(listObj)}},setImpr=slotNum=>{const impr=selectedMyFleetList[selectedFleetNum].impr[slotNum],form=$("<input>",{type:"number",id:`impr${slotNum}`,class:"form-control impr inline-b item-opt",placeholder:"改修",value:`${impr||void 0}`});form.on("input",(function(){form.val(Math.max(form.val(),0)),form.val(Math.min(form.val(),10));const item=selectedMyFleetList[selectedFleetNum].item[slotNum];let itemPower=0,itemTorp=0,itemBomb=0,power=0;power+=selectedMyFleetList[selectedFleetNum].fleet.power,itemAccuracy=0;const singleAddableBonus=item.singleAddableBonus?getSingleAddableBonus(item):0,singleBonus=item.singleBonus?getSingleBonus(item,slotNum):0,multiBonus=getMultiBonus(selectedMyFleetList[selectedFleetNum].item);selectedMyFleetList[selectedFleetNum].item[slotNum].power=selectedMyFleetList[selectedFleetNum].item[slotNum].power?selectedMyFleetList[selectedFleetNum].item[slotNum].power:0,selectedMyFleetList[selectedFleetNum].item[slotNum].torp=(selectedMyFleetList[selectedFleetNum].item[slotNum].torp?selectedMyFleetList[selectedFleetNum].item[slotNum].torp:0)+(singleAddableBonus.torp?singleAddableBonus.torp:0)+(singleBonus.torp?singleBonus.torp:0),selectedMyFleetList[selectedFleetNum].item[slotNum].bonusPower=(singleAddableBonus.power?singleAddableBonus.power:0)+(singleBonus.power?singleBonus.power:0),power+=multiBonus.power?multiBonus.power:0,selectedMyFleetList[selectedFleetNum].item.forEach(t=>{0!=t&&(itemPower+=(t.power?t.power:0)+(t.bonusPower?t.bonusPower:0),itemTorp+=t.torp?t.torp:0,itemBomb+=t.bomb?t.bomb:0,itemAccuracy+=t.accuracy?t.accuracy:0)}),power+=itemPower,2==selectedMyFleetList[selectedFleetNum].fleet.type?power=Math.floor(1.5*(power+itemTorp+Math.floor(1.3*itemBomb)-1))+55:power+=4,selectedMyFleetList[selectedFleetNum].item[slotNum]=item,selectedMyFleetList[selectedFleetNum].impr[slotNum]=form.val(),$(".myfleet .power").html(power),$(".myfleet .accuracy").html(itemAccuracy),getResultData()})),$(`#itemSlot${slotNum}`).parent().parent().append($("<td>").append(form))};function round(number,precision){let shift=function(number,precision,reverseShift){reverseShift&&(precision=-precision);let numArray=(""+number).split("e");return+(numArray[0]+"e"+(numArray[1]?+numArray[1]+precision:precision))};return shift(Math.round(shift(number,precision,!1)),precision,!0)}const setSauin=isActive=>{if(isActive){const form=$("<input>",{type:"checkbox",class:"form-check-input",id:"saiunCheck",onclick:"getResultData()"}),label=$("<label>",{class:"form-check-label",text:"彩雲",for:"saiunCheck"}),div=$("<div>",{class:"form-check"});div.append(form).append(label),$(".saiunSet").append(div)}else $(".saiunSet").children().remove()},saveEnemyStatus=(shipId,hp,armor,avoidance,luck)=>{const data=[avoidance,luck,hp,armor];localStorage.setItem(`${shipId}`,`${data}`),$(".status-reset").css("display","block"),$(".status").addClass("saved-info")},resetEnemyStatus=shipId=>{localStorage.removeItem(shipId),$(".enemy .hp").val(selectedEnemyFleet.hp),$(".enemy .armor").val(selectedEnemyFleet.armor),$(".enemy .avoidance").val(selectedEnemyFleet.avoidance),$(".enemy .luck").val(selectedEnemyFleet.luck);const title=`装甲 ${selectedEnemyFleet.armor}, 耐久 ${selectedEnemyFleet.hp}`;$(`[data-id="${selectedEnemyFleet.id}"]`).children(".item-tooltip").attr("title",title).tooltip("fixTitle")},getSavedFleetNumber=()=>{let fleetNumber=0;for(;localStorage.getItem("fleet"+fleetNumber);)fleetNumber++;return fleetNumber},getFleetName=()=>{let name=$(".form-control.fleet-name").val();return""==name&&(name="example"),name},getFleetComment=()=>{let text;return $(".form-control.fleet-comment").val()},saveFleet=(fleetName,fleetComment,deckCode,fleetNumber)=>{const isEmpty=!deckCode.match(/s[1-6]/);if(isEmpty)return!1;const data={deckCode:deckCode,fleetName:fleetName,fleetComment:fleetComment},jsonData=JSON.stringify(data);return localStorage.setItem("fleet"+fleetNumber,jsonData),!0},deleteFleet=fleetNumber=>{for(localStorage.removeItem("fleet"+fleetNumber);localStorage.getItem("fleet"+(fleetNumber+1));){const data=localStorage.getItem("fleet"+(fleetNumber+1));localStorage.setItem("fleet"+fleetNumber,data),fleetNumber++}localStorage.removeItem("fleet"+fleetNumber)},setSavedFleetList=()=>{$(".saved-fleetlist tbody").empty();let fleetNumber=0;for(;localStorage.getItem("fleet"+fleetNumber);){const data=localStorage.getItem("fleet"+fleetNumber),jsonData=JSON.parse(data),fleetName=jsonData.fleetName,fleetComment=jsonData.fleetComment,deckCode=jsonData.deckCode,listObj=$("<tr>",{class:"saved-fleet"}),banner=$("<td>"),raw=JSON.parse(deckCode);if(toString(raw.version).includes("4"))return!1;for(const i in raw){if(!raw[i])continue;const fleet=raw[i];for(const j in fleet){if(!fleet[j].id)continue;const ship=fleet[j],img=$("<img>",{class:"banner",src:`./images/ships/${ship.id}.png`,alt:`${ship.name}`});banner.append(img),j[1]%2==0&&0!=j[1]&&banner.append($("<br>"))}}const button=$("<button>",{type:"button",class:"btn btn-default",text:"展開","data-fleetNumber":fleetNumber,"data-toggle":"modal","data-target":"#save-fleet"}),button2=$("<button>",{type:"button",class:"btn btn-default",text:"上書き","data-fleetNumber":fleetNumber}),button3=$("<button>",{type:"button",class:"btn btn-danger",text:"削除","data-fleetNumber":fleetNumber,"data-toggle":"modal","data-target":"#delete-check"});button.on("click",(function(){const fleetNumber=button3.data("fleetnumber"),data=localStorage.getItem("fleet"+fleetNumber),jsonData=JSON.parse(data),deckCode=jsonData.deckCode;checkDeckBuilder(deckCode)})),button2.on("click",(function(){const fleetNumber=button3.data("fleetnumber"),fleetComment=getFleetComment(),deckCode=getDeckBuilder(),isSuccess=saveFleet(fleetName,fleetComment,deckCode,fleetNumber);isSuccess?setSavedFleetList():alert("空の艦隊で上書きできません")})),button3.on("click",(function(){$("#delete-fleet").attr("data-fleetnumber",button3.data("fleetnumber"))}));const text=$("<td>");text.append(fleetName).append($("<br>")).append($("<br>")).append(button).append(button2).append(button3),listObj.append(banner).append(text),$(".saved-fleetlist tbody").append(listObj),fleetNumber++}},setItemTab=type=>{switch(type){case 1:$("#gun-tab").click(),$("#l-gun-tab").click();break;case 2:$("#plane-tab").click();break;case 3:case 4:$("#gun-tab").click(),$("#m-gun-tab").click();break;case 5:$("#gun-tab").click(),$("#s-gun-tab").click()}};